name: Generate README Cards

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate top-langs.svg (pretty + safe)
        env:
          USERNAME: mcemy
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          mkdir -p assets/cards

          python3 - << 'PY'
          import json, os, urllib.request

          username = os.environ["USERNAME"]
          token = os.environ["TOKEN"]

          query = """
          query($login:String!) {
            user(login:$login) {
              repositories(ownerAffiliations: OWNER, isFork:false, first: 100, orderBy:{field:UPDATED_AT, direction:DESC}) {
                nodes {
                  languages(first: 10, orderBy:{field:SIZE, direction:DESC}) {
                    edges { size node { name } }
                  }
                }
              }
            }
          }
          """

          body = json.dumps({"query": query, "variables": {"login": username}}).encode()
          req = urllib.request.Request(
            "https://api.github.com/graphql",
            data=body,
            headers={
              "Authorization": f"Bearer {token}",
              "Content-Type": "application/json",
              "User-Agent": "readme-cards"
            },
            method="POST"
          )
          data = json.loads(urllib.request.urlopen(req, timeout=30).read().decode())
          repos = data["data"]["user"]["repositories"]["nodes"]

          totals = {}
          for repo in repos:
            for e in repo["languages"]["edges"]:
              name = e["node"]["name"]
              totals[name] = totals.get(name, 0) + e["size"]

          top = sorted(totals.items(), key=lambda x: x[1], reverse=True)[:8]
          total = sum(v for _, v in top) or 1

          bg = "#FFE3EC"
          title = "#2E2A25"
          text = "#2E2A25"
          border = "#E8DCCF"
          bar_bg = "#FFFFFF"
          bar_fill = "#7AA6A1"
          palette = ["#7AA6A1", "#C7A7CC", "#FFB3C1", "#A9C6E8", "#B7D7A8", "#F2C14E", "#E26D5C", "#9D8189"]

          W, H = 520, 240
          pad = 22

          def esc(s):
            return (s.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")
                    .replace('"',"&quot;").replace("'","&apos;"))

          svg = []
          svg.append(f'<svg xmlns="http://www.w3.org/2000/svg" width="{W}" height="{H}" viewBox="0 0 {W} {H}">')
          svg.append(f'<rect x="10" y="10" width="{W-20}" height="{H-20}" rx="14" fill="{bg}" stroke="{border}"/>')
          svg.append(f'<text x="{pad}" y="44" font-family="Segoe UI,Verdana,Arial" font-size="18" fill="{title}" font-weight="700">Most Used Languages</text>')

          start_y = 72
          row_h = 20
          dot_r = 5
          dot_x = pad
          name_x = pad + 16
          bar_x = pad + 170
          bar_w = 220
          bar_h = 8
          pct_x = W - pad

          y = start_y
          for i, (lang, size) in enumerate(top):
            pct = (size / total) * 100
            fill_w = max(int(bar_w * (pct/100)), 2)
            c = palette[i % len(palette)]

            svg.append(f'<circle cx="{dot_x}" cy="{y-4}" r="{dot_r}" fill="{c}"/>')
            svg.append(f'<text x="{name_x}" y="{y}" font-family="Segoe UI,Verdana,Arial" font-size="12" fill="{text}">{esc(lang)}</text>')
            svg.append(f'<rect x="{bar_x}" y="{y-10}" width="{bar_w}" height="{bar_h}" rx="4" fill="{bar_bg}" opacity="0.65"/>')
            svg.append(f'<rect x="{bar_x}" y="{y-10}" width="{fill_w}" height="{bar_h}" rx="4" fill="{bar_fill}" opacity="0.95"/>')
            svg.append(f'<text x="{pct_x}" y="{y}" text-anchor="end" font-family="Segoe UI,Verdana,Arial" font-size="12" fill="{text}">{pct:.1f}%</text>')

            y += row_h

          svg.append(f'<text x="{pad}" y="{H-22}" font-family="Segoe UI,Verdana,Arial" font-size="10" fill="{text}" opacity="0.55">Auto-updated daily</text>')
          svg.append('</svg>')

          with open("assets/cards/top-langs.svg", "w", encoding="utf-8") as f:
            f.write("\n".join(svg))
          PY

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add assets/cards/top-langs.svg
          git commit -m "chore: update top-langs card" || exit 0
          git push
